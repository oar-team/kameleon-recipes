#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: Debian generic recipe using the debootstrap mechanism
#
# USAGE:
#   Select directly in this recipe:
#
#   - distribution: debian or ubuntu
#   - release: wheezy, testing, sid...
#   - architechture: default amd64
#
#   or, override the globals directly in CLI:
#
#   kameleon build --global distrib:debian --global release:wheezy
#
#   or extends this recipe with your own and override those variable in it.
#
#==============================================================================
---
extend: base-qemu.yaml

global:
  distrib: debian
  release: stable
  deb_kernel_arch: $${deb_arch}

  bootstrap_packages: locales openssh-server linux-image-$${deb_kernel_arch}

  apt_enable_contrib: true
  apt_enable_nonfree: true

  qemu_uefi: true
  image_disk: $${kameleon_cwd}/$${kameleon_recipe_name}_disk
  qemu_additional_disks: $${image_disk}1,$${image_disk}2:1G,$${image_disk}3:512M:raw

bootstrap:
  - download_installer
  - prepare_qemu_disk
  - prepare_qemu_additional_disks
  - prepare_ssh_to_out_context
  - start_qemu
  - breakpoint
  - install_build_packages:
    - configure_apt_sources:
      - exec_out: echo "deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware" > /etc/apt/sources.list
      - apt-get_out: update
    - install_requirements:
      - apt-get_out: install debootstrap gdisk dkms linux-headers-generic zfsutils-linux
    - check_uefi:
      - exec_out: dmesg | grep -i efivars
  - prepare_partition_for_rootfs
  - debootstrap
  - prepare_system_fs_for_chroot
  - debootstrap_post_config

setup:
  - "@base"
export:
  - "@base"
