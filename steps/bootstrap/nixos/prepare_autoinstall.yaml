- insecure_ssh_key: $${kameleon_cwd}/insecure_ssh_key

- copy_autoinstall_script_to_http_directory:
  - exec_local: mkdir -p $${http_directory}
  - exec_local: cp $${autoinstall_script_path} $${http_directory}/autoinstall.sh
  - exec_local: cp $${nix_configuration} $${http_directory}/configuration.nix
  - exec_local: cp $${nix_hardware_configuration} $${http_directory}/hardware-configuration.nix

- configure_proxy:
  - exec_local: |
      if [ -n "$${proxy_out}" ]; then
        sed -i -e "s|%HTTP_PROXY%|http://$${proxy_out}|g" $${http_directory}/autoinstall.sh
      else
        sed -i -e "s|%HTTP_PROXY%||g" $${http_directory}/autoinstall.sh
      fi

- set_root_password:
  - exec_local: |
        INSECURE_SSH_KEY_PUB=$(< $${insecure_ssh_key}.pub)
        sed -i -e "s|%PASSWORD%|$${root_password}|g" $${http_directory}/autoinstall.sh
        sed -i -e "s|%LOCAL_IP%|$${local_ip}|g" $${http_directory}/autoinstall.sh
        sed -i -e "s|%HTTP_PORT%|$HTTP_PORT|g" $${http_directory}/autoinstall.sh
        sed -i -e "s|%PASSWORD%|$${root_password}|g" $${http_directory}/configuration.nix
        sed -i -e "s|%SSH_PUBLIC_KEY%|$INSECURE_SSH_KEY_PUB|g" $${http_directory}/configuration.nix
